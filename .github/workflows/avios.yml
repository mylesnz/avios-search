name: Daily Qatar Avios EU Email

on:
  workflow_dispatch:
  schedule:
    # Runs daily at 07:00 UTC (~20:00 NZT during DST). Adjust if you want.
    - cron: "0 7 * * *"

concurrency:
  group: avios-daily
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      # required secrets
      SEATSAERO_API_KEY: ${{ secrets.SEATSAERO_API_KEY }}
      FROM_EMAIL:        ${{ secrets.FROM_EMAIL }}
      TO_EMAIL:          ${{ secrets.TO_EMAIL }}
      BREVO_API_KEY:     ${{ secrets.BREVO_API_KEY }}
      # optional overrides (leave unset unless you really need to point elsewhere)
      SEATSAERO_AVAIL_URL:  ${{ secrets.SEATSAERO_AVAIL_URL }}
      SEATSAERO_ROUTES_URL: ${{ secrets.SEATSAERO_ROUTES_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify required secrets
        run: |
          missing=0
          for key in SEATSAERO_API_KEY FROM_EMAIL TO_EMAIL BREVO_API_KEY; do
            if [ -z "$(printenv "$key")" ]; then
              echo "‚ùå Missing secret: $key"; missing=1
            else
              echo "‚úÖ $key present"
            fi
          done
          if [ $missing -ne 0 ]; then
            echo "Some required secrets are missing. Add them under Repo ‚Üí Settings ‚Üí Secrets ‚Üí Actions."
            exit 1
          fi

      - name: Preflight Seats.Aero (routes)
        run: |
          python - <<'PY'
          import os, sys, urllib.request, urllib.error, json
          key=os.environ["SEATSAERO_API_KEY"].strip()
          base=os.environ.get("SEATSAERO_ROUTES_URL","https://seats.aero/partnerapi/routes")
          url=f"{base}?carrier=QR&region=EU"
          req=urllib.request.Request(url, headers={
            "Accept":"application/json",
            "User-Agent":"Mozilla/5.0",
            "Partner-Authorization": key
          })
          try:
              with urllib.request.urlopen(req, timeout=30) as r:
                  data=json.loads(r.read().decode())
                  n=len(data["data"]) if isinstance(data,dict) and "data" in data else (len(data) if isinstance(data,list) else 0)
                  print(f"‚úÖ Seats.Aero reachable, sample count={n}")
          except urllib.error.HTTPError as e:
              body=e.read().decode(errors="replace")[:800]
              if e.code==403:
                  print("‚ùå Cloudflare 403 on runner. Share this with Seats.Aero to allowlist the Actions egress:\n", body)
              else:
                  print(f"‚ùå HTTP {e.code} {e.reason}\n{body}")
              sys.exit(1)
          PY

      - name: Run Avios daily script
        run: |
          echo "üöÄ Running seats_avios_daily.py ..."
          python seats_avios_daily.py
